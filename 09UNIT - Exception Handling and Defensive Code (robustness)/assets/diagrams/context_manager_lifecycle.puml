@startuml context_manager_lifecycle

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam sequenceGroupBodyBackgroundColor #F8F9FA
skinparam sequenceLifeLineBorderColor #6C757D

title Context Manager Lifecycle

participant "with statement" as With
participant "__enter__()" as Enter
participant "Managed Block" as Block
participant "__exit__()" as Exit

activate With

With -> Enter : 1. Acquire resource
activate Enter
Enter --> With : return value (as target)
deactivate Enter

group Managed Block [try]
    With -> Block : 2. Execute body
    activate Block
    
    alt Success path
        Block --> With : no exception
        deactivate Block
        
        With -> Exit : 3a. __exit__(None, None, None)
        activate Exit
        Exit --> With : cleanup complete
        deactivate Exit
        
    else Exception raised
        Block --> With : exception raised
        deactivate Block
        
        With -> Exit : 3b. __exit__(exc_type, exc_val, exc_tb)
        activate Exit
        
        alt Return True
            Exit --> With : suppress exception
        else Return False
            Exit --> With : propagate exception
        end
        deactivate Exit
    end
end

deactivate With

note over Enter
  Resource acquisition
  (open file, connect, lock)
end note

note over Exit
  Guaranteed cleanup
  regardless of success
  or exception
end note

@enduml
